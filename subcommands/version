#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

service-version-cmd() {
  #E show DNS plugin version and dependency versions
  #E dokku $PLUGIN_COMMAND_PREFIX:version
  #E displays the DNS plugin version from plugin.toml and AWS CLI version
  declare desc="show DNS plugin version and dependency versions"
  local cmd="$PLUGIN_COMMAND_PREFIX:version" argv=("$@")
  [[ ${argv[0]} == "$cmd" ]] && shift 1

  local PLUGIN_ROOT
  PLUGIN_ROOT="$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")"
  local VERSION_FILE="$PLUGIN_ROOT/plugin.toml"
  
  # Show plugin version
  if [[ -f "$VERSION_FILE" ]]; then
    local VERSION
    VERSION=$(grep "^version" "$VERSION_FILE" | cut -d'"' -f2)
    if [[ -n "$VERSION" ]]; then
      echo "dokku-dns plugin version: $VERSION"
    else
      echo "dokku-dns plugin version: unknown (version not found in plugin.toml)"
    fi
  else
    echo "dokku-dns plugin version: unknown (plugin.toml not found)"
  fi

  # Show git commit info if available
  if [[ -d "$PLUGIN_ROOT/.git" ]] && command -v git >/dev/null 2>&1; then
    local GIT_SHA GIT_DATE
    GIT_SHA=$(git -C "$PLUGIN_ROOT" rev-parse --short HEAD 2>/dev/null || echo "")
    GIT_DATE=$(git -C "$PLUGIN_ROOT" log -1 --format="%ci" 2>/dev/null || echo "")
    if [[ -n "$GIT_SHA" ]]; then
      echo "Git commit: $GIT_SHA ($GIT_DATE)"
    fi
  fi
  
  # Show AWS CLI version if installed
  if command -v aws >/dev/null 2>&1; then
    local AWS_VERSION
    AWS_VERSION=$(aws --version 2>&1 | head -1 | awk '{print $1}' | sed 's/^aws-cli\///')
    echo "AWS CLI version: $AWS_VERSION"
  else
    echo "AWS CLI: not installed"
  fi
}

service-version-cmd "$@"
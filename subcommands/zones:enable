#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

# Check if a domain belongs to a specific zone
# Usage: is_domain_in_zone <domain> <zone>
# Returns: 0 if domain is in zone, 1 if not
is_domain_in_zone() {
  local DOMAIN="$1"
  local ZONE="$2"

  # Check if domain matches this zone exactly or is a subdomain
  if [[ "$DOMAIN" == "$ZONE" ]] || [[ "$DOMAIN" == *".$ZONE" ]]; then
    return 0
  else
    return 1
  fi
}

# Show suggested next steps after enabling a zone
# Usage: show_zone_enable_next_steps <zone>
show_zone_enable_next_steps() {
  local ZONE="$1"

  # Get all apps
  local apps
  if ! command -v dokku >/dev/null 2>&1; then
    return 0  # Skip if dokku command not available
  fi

  apps=$(dokku apps:list 2>/dev/null | tail -n +2 || echo "")

  if [[ -z "$apps" ]]; then
    return 0  # No apps to check
  fi

  # Build a map of app -> domains in this zone
  declare -A app_domains_map
  local found_any=false

  while IFS= read -r app; do
    [[ -z "$app" ]] && continue

    # Get domains for this app
    local domains
    domains=$(get_app_domains "$app" 2>/dev/null || echo "")

    # Find domains that are in this zone
    local zone_domains=()
    while IFS= read -r domain; do
      [[ -z "$domain" ]] && continue

      if is_domain_in_zone "$domain" "$ZONE"; then
        zone_domains+=("$domain")
        found_any=true
      fi
    done <<< "$domains"

    # Store domains for this app if any found
    if [[ ${#zone_domains[@]} -gt 0 ]]; then
      app_domains_map["$app"]="${zone_domains[*]}"
    fi
  done <<< "$apps"

  # Display suggestions if we found any apps with domains in this zone
  if [[ "$found_any" == "true" ]]; then
    echo
    dokku_log_info1 "Next steps - enable DNS management for apps with domains in this zone:"
    echo

    for app in "${!app_domains_map[@]}"; do
      local domains="${app_domains_map[$app]}"
      # Convert space-separated domains to comma-separated for comment
      local domain_comment="${domains// /, }"
      echo "  dokku dns:apps:enable $app  # $domain_comment"
    done

    echo
  fi
}

# Show suggested next steps for all enabled zones
# Usage: show_all_zones_enable_next_steps
show_all_zones_enable_next_steps() {
  # Get all apps
  local apps
  if ! command -v dokku >/dev/null 2>&1; then
    return 0  # Skip if dokku command not available
  fi

  apps=$(dokku apps:list 2>/dev/null | tail -n +2 || echo "")

  if [[ -z "$apps" ]]; then
    return 0  # No apps to check
  fi

  # Build a map of app -> domains in any enabled zone
  declare -A app_domains_map
  local found_any=false

  while IFS= read -r app; do
    [[ -z "$app" ]] && continue

    # Get domains for this app
    local domains
    domains=$(get_app_domains "$app" 2>/dev/null || echo "")

    # Find domains that are in any enabled zone
    local zone_domains=()
    while IFS= read -r domain; do
      [[ -z "$domain" ]] && continue

      if is_domain_in_enabled_zone "$domain"; then
        zone_domains+=("$domain")
        found_any=true
      fi
    done <<< "$domains"

    # Store domains for this app if any found
    if [[ ${#zone_domains[@]} -gt 0 ]]; then
      app_domains_map["$app"]="${zone_domains[*]}"
    fi
  done <<< "$apps"

  # Display suggestions if we found any apps with domains in enabled zones
  if [[ "$found_any" == "true" ]]; then
    echo
    dokku_log_info1 "Next steps - enable DNS management for apps with domains in enabled zones:"
    echo

    for app in "${!app_domains_map[@]}"; do
      local domains="${app_domains_map[$app]}"
      # Convert space-separated domains to comma-separated for comment
      local domain_comment="${domains// /, }"
      echo "  dokku dns:apps:enable $app  # $domain_comment"
    done

    echo
  fi
}

service-zones-enable-cmd() {
  #E enable DNS zone for automatic app domain management
  #E dokku $PLUGIN_COMMAND_PREFIX:zones:enable example.com
  #E dokku $PLUGIN_COMMAND_PREFIX:zones:enable --all
  #E enables automatic discovery of app domains within the specified zone
  #E when apps have domains in this zone, they will be automatically managed
  #E use 'dokku $PLUGIN_COMMAND_PREFIX:apps:enable' to manually add specific apps
  #A zone, zone name to enable for auto-discovery (optional with --all)
  #F --all, enable all available zones for auto-discovery
  declare desc="enable DNS zone for automatic app domain management"
  local cmd="$PLUGIN_COMMAND_PREFIX:zones:enable" argv=("$@")
  
  # Handle Dokku command routing - first argument will be the command name
  if [[ "$1" == "$cmd" ]]; then
    shift 1
  fi
  
  declare ZONE=""
  local all_zones=false
  
  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case $1 in
      --all)
        all_zones=true
        shift
        ;;
      *)
        if [[ -z "$ZONE" ]]; then
          ZONE="$1"
        else
          dokku_log_fail "Unknown option: $1. Use <zone> or --all."
        fi
        shift
        ;;
    esac
  done
  
  # Validate arguments
  if [[ -z "$ZONE" && "$all_zones" == "false" ]]; then
    dokku_log_fail "Please specify a zone name or use --all flag"
  fi
  
  if [[ -n "$ZONE" && "$all_zones" == "true" ]]; then
    dokku_log_fail "Cannot specify both zone name and --all flag together"
  fi
  
  # Execute actions
  if [[ "$all_zones" == "true" ]]; then
    zones_add_all
  else
    zones_add_zone "$ZONE"
  fi
}

zones_add_zone() {
  local ZONE="$1"
  
  
  
  # Validate AWS dependencies
  if ! command -v aws >/dev/null 2>&1; then
    dokku_log_fail "AWS CLI is not installed. Please install aws-cli to use AWS Route53 provider."
  fi
  
  if ! aws sts get-caller-identity >/dev/null 2>&1; then
    dokku_log_fail "AWS CLI is not configured or credentials are invalid."
  fi
  
  dokku_log_info2 "Adding zone to auto-discovery: $ZONE"
  
  # Get zone ID to verify it exists
  local ZONE_ID
  ZONE_ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name=='${ZONE}.'].Id" --output text 2>/dev/null | sed 's|/hostedzone/||')
  
  if [[ -z "$ZONE_ID" ]] || [[ "$ZONE_ID" == "None" ]]; then
    dokku_log_fail "Zone '$ZONE' not found in Route53. Available zones:"
    aws route53 list-hosted-zones --query 'HostedZones[].Name' --output text 2>/dev/null | sed 's/\.$//g' | while read -r zone; do
      echo "  â€¢ $zone"
    done
    return 1
  fi
  
  # Mark zone as enabled for auto-discovery
  zones_set_enabled "$ZONE"

  dokku_log_info1 "Zone '$ZONE' added to auto-discovery"

  # Show suggested next steps for apps with domains in this zone
  show_zone_enable_next_steps "$ZONE"
}

zones_add_all() {
  
  
  # Validate AWS dependencies
  if ! command -v aws >/dev/null 2>&1; then
    dokku_log_fail "AWS CLI is not installed. Please install aws-cli to use AWS Route53 provider."
  fi
  
  if ! aws sts get-caller-identity >/dev/null 2>&1; then
    dokku_log_fail "AWS CLI is not configured or credentials are invalid."
  fi
  
  dokku_log_info2 "Adding all zones to auto-discovery"
  
  # Get all hosted zones
  local ZONES
  ZONES=$(aws route53 list-hosted-zones --query 'HostedZones[].Name' --output text 2>/dev/null | tr '\t' ' ' | sed 's/\.$//g')
  
  if [[ -z "$ZONES" ]]; then
    dokku_log_info1 "No hosted zones found in Route53"
    return 0
  fi
  
  local zones_processed=0
  
  for zone in $ZONES; do
    dokku_log_info1 "Adding zone: $zone"
    zones_processed=$((zones_processed + 1))

    # Add this zone to auto-discovery
    zones_set_enabled "$zone"
    echo
  done

  dokku_log_info1 "Zones added to auto-discovery: $zones_processed"

  # Show suggested next steps for all apps with domains in enabled zones
  show_all_zones_enable_next_steps
}

service-zones-enable-cmd "$@"
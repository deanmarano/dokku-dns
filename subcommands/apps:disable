#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Load common fallback functions
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/common-functions"

# Define missing functions if needed
if ! declare -f verify_app_name >/dev/null 2>&1; then
  verify_app_name() {
    local app="$1"
    [[ -n "$app" ]] || { echo " !     Please specify an app name" >&2; exit 1; }

    # Check if app exists (only if dokku command is available)
    if command -v dokku >/dev/null 2>&1; then
      if ! dokku apps:list 2>/dev/null | grep -q "^$app$"; then
        dokku_log_fail "App $app does not exist"
      fi
    fi
  }
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

service-apps-disable-cmd() {
  #E disable DNS management for an application
  #E dokku $PLUGIN_COMMAND_PREFIX:apps:disable nextcloud
  #E removes app from DNS management but does not delete existing DNS records
  #E this only removes the app from the DNS tracking system
  #E to clean up DNS records, use 'dokku $PLUGIN_COMMAND_PREFIX:apps:sync' before disabling
  #A app, app to disable DNS management for
  declare desc="disable DNS management for an application"
  local cmd="$PLUGIN_COMMAND_PREFIX:apps:disable" argv=("$@")
  [[ ${argv[0]} == "$cmd" ]] && shift 1
  declare APP="$1"

  [[ -z "$APP" ]] && dokku_log_fail "Please specify an app name"
  verify_app_name "$APP"
  
  # Check if app is currently added to DNS
  if ! is_app_dns_managed "$APP"; then
    dokku_log_warn "App '$APP' is not currently added to DNS"
    dokku_log_info1 "Nothing to remove. Current status: not added"
    return 0
  fi
  
  dns_remove_app "$APP"
}

service-apps-disable-cmd "$@"
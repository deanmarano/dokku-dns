#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

service-sync-all-cmd() {
  #E synchronize DNS records for all apps with DNS management enabled
  #E dokku $PLUGIN_COMMAND_PREFIX:sync-all
  #E this will iterate through all apps that have DNS management enabled
  #E and sync their DNS records using the configured provider.
  #E AWS Route53 uses efficient batch API calls grouped by hosted zone.
  #E Other providers sync each app individually for compatibility.
  declare desc="synchronize DNS records for all DNS-managed apps"

  local LINKS_FILE="$PLUGIN_DATA_ROOT/LINKS"

  if [[ ! -f "$LINKS_FILE" ]]; then
    echo "No apps in DNS management"
    return 0
  fi

  local apps=()
  while IFS= read -r app; do
    [[ -n "$app" ]] && apps+=("$app")
  done < "$LINKS_FILE"

  if [[ ${#apps[@]} -eq 0 ]]; then
    echo "No apps in DNS management"
    return 0
  fi

  local SERVER_IP
  SERVER_IP=$(get_server_ip)
  if [[ "$SERVER_IP" == "Unknown" ]]; then
    echo "Error: cannot detect server IP"
    return 1
  fi

  # Load provider system
  local ADAPTER_PATH
  ADAPTER_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)/providers/adapter.sh"
  source "$ADAPTER_PATH"

  if ! init_provider_system 2>/dev/null; then
    echo "Error: no DNS provider configured"
    return 1
  fi

  local total_synced=0 total_failed=0

  for app in "${apps[@]}"; do
    local domains_file="$PLUGIN_DATA_ROOT/$app/DOMAINS"
    [[ ! -f "$domains_file" ]] && continue

    echo "=== $app ==="

    while IFS= read -r domain; do
      [[ -z "$domain" ]] && continue

      local zone_id
      if ! zone_id=$(multi_get_zone_id "$domain" 2>/dev/null); then
        echo "✗ $domain (no zone)"
        total_failed=$((total_failed + 1))
        continue
      fi

      local current_ip
      current_ip=$(multi_get_record "$zone_id" "$domain" "A" 2>/dev/null || echo "")

      if [[ "$current_ip" == "$SERVER_IP" ]]; then
        echo "✓ $domain"
        total_synced=$((total_synced + 1))
        continue
      fi

      local ttl
      ttl=$(get_domain_ttl "$app" "$domain" 2>/dev/null || echo "300")

      if multi_create_record "$zone_id" "$domain" "A" "$SERVER_IP" "$ttl" 2>/dev/null; then
        echo "✓ $domain (updated)"
        total_synced=$((total_synced + 1))
      else
        echo "✗ $domain (failed)"
        total_failed=$((total_failed + 1))
      fi
    done < "$domains_file"
  done

  echo
  echo "Total: $total_synced synced, $total_failed failed"
  [[ $total_failed -eq 0 ]]
}

service-sync-all-cmd "$@"

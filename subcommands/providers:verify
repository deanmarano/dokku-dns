#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

service-providers-verify-cmd() {
  #E verify DNS provider setup and connectivity, discover existing DNS records
  #E dokku $PLUGIN_COMMAND_PREFIX:providers:verify [--verbose] [provider]
  #E verify specific provider or all available providers if none specified
  #E checks credentials, tests API access, shows available zones/domains for each provider
  #F -v|--verbose, show detailed output (default shows summary only)
  #A provider, optional DNS provider to verify (aws, cloudflare, digitalocean) - defaults to all available providers
  declare desc="verify DNS provider setup and connectivity"
  local cmd="$PLUGIN_COMMAND_PREFIX:providers:verify" argv=("$@")
  [[ ${argv[0]} == "$cmd" ]] && shift 1

  local VERBOSE=false
  local PROVIDER_ARG=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -v|--verbose) VERBOSE=true; shift ;;
      *) PROVIDER_ARG="$1"; shift ;;
    esac
  done

  # Check jq dependency
  if ! command -v jq &>/dev/null; then
    echo "Error: jq is required. Install with: apt-get install jq"
    return 1
  fi

  local LOADER_PATH
  LOADER_PATH="$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/providers/loader.sh"
  source "$LOADER_PATH"

  # Determine providers to verify
  local providers=()
  if [[ -n "$PROVIDER_ARG" ]]; then
    providers=("$PROVIDER_ARG")
  else
    # Auto-detect configured providers
    providers=("aws")
    [[ -n "${CLOUDFLARE_API_TOKEN:-}" ]] && providers+=("cloudflare")
    [[ -n "${DIGITALOCEAN_ACCESS_TOKEN:-}" ]] && providers+=("digitalocean")
  fi

  local any_success=false

  for provider in "${providers[@]}"; do
    local status="✗" zones="" zone_count=0 error=""

    if load_specific_provider "$provider" 2>/dev/null; then
      if provider_validate_credentials 2>/dev/null; then
        if zones=$(provider_list_zones 2>/dev/null); then
          zone_count=$(echo "$zones" | grep -c . || echo 0)
          status="✓"
          any_success=true
        else
          error="cannot list zones"
        fi
      else
        error="auth failed"
      fi
    else
      error="not configured"
    fi

    # Simple output
    if [[ "$status" == "✓" ]]; then
      echo "$status $provider: $zone_count zone(s)"
    else
      echo "$status $provider: $error"
    fi

    # Verbose: show zone list
    if [[ "$VERBOSE" == "true" ]] && [[ -n "$zones" ]]; then
      while IFS= read -r z; do
        echo "    $z"
      done <<< "$zones"
    fi
  done

  [[ "$any_success" == "true" ]]
}

service-providers-verify-cmd "$@"

#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

service-report-cmd() {
  #E display DNS status and domain information for app(s)
  #E dokku $PLUGIN_COMMAND_PREFIX:report [app]
  #E shows server IP, domains, DNS status with emojis, and hosted zones
  #E without app: shows all apps and their domains
  #E with app: shows detailed report for specific app
  #E DNS status: CORRECT correct, WARNING wrong IP, ERROR no record
  #A app, app to generate DNS report for (optional - shows all apps if omitted)
  declare desc="display DNS status and domain information for app(s)"
  local cmd="$PLUGIN_COMMAND_PREFIX:report" argv=("$@")
  [[ ${argv[0]} == "$cmd" ]] && shift 1
  declare APP="$1"

  local SERVER_IP
  SERVER_IP=$(get_server_ip)

  if [[ -z "$APP" ]]; then
    dns_global_report "$SERVER_IP"
  else
    dns_app_report "$APP" "$SERVER_IP"
  fi
}

dns_global_report() {
  local SERVER_IP="$1"
  local APPS_LIST
  APPS_LIST=$(get_dns_managed_apps)

  if [[ -z "$APPS_LIST" ]]; then
    echo "No apps in DNS management"
    return 0
  fi

  echo "Server IP: $SERVER_IP"
  echo
  printf "%-15s %-30s %-6s %s\n" "APP" "DOMAIN" "STATUS" "ZONE"
  printf "%-15s %-30s %-6s %s\n" "---" "------" "------" "----"

  local total=0 correct=0

  while IFS= read -r app; do
    [[ -z "$app" ]] && continue
    local domains_file="$PLUGIN_DATA_ROOT/$app/DOMAINS"
    [[ ! -f "$domains_file" ]] && continue

    local first=true
    while IFS= read -r domain; do
      [[ -z "$domain" ]] && continue
      total=$((total + 1))

      # Get current IP (use dig for speed)
      local current_ip status
      current_ip=$(dig +short "$domain" A 2>/dev/null | head -1 || echo "")

      if [[ -z "$current_ip" ]]; then
        status="✗"
      elif [[ "$current_ip" == "$SERVER_IP" ]]; then
        status="✓"
        correct=$((correct + 1))
      else
        status="⚠"
      fi

      # Get zone from domain
      local zone
      zone=$(echo "$domain" | awk -F. '{if(NF>=2) print $(NF-1)"."$NF; else print $0}')

      local app_col=""
      [[ "$first" == "true" ]] && app_col="$app"
      first=false

      printf "%-15s %-30s %-6s %s\n" "$app_col" "$domain" "$status" "$zone"
    done < "$domains_file"
  done <<< "$APPS_LIST"

  echo
  echo "$correct/$total domains correct"
}

dns_app_report() {
  local APP="$1"
  local SERVER_IP="$2"

  if ! is_app_dns_managed "$APP"; then
    echo "App '$APP' not in DNS management"
    echo "Enable with: dokku dns:apps:enable $APP"
    return 1
  fi

  local domains_file="$PLUGIN_DATA_ROOT/$APP/DOMAINS"
  if [[ ! -f "$domains_file" ]]; then
    echo "No domains configured"
    return 0
  fi

  echo "App: $APP"
  echo "Server IP: $SERVER_IP"
  echo
  printf "%-35s %-6s %-15s\n" "DOMAIN" "STATUS" "CURRENT IP"
  printf "%-35s %-6s %-15s\n" "------" "------" "----------"

  local total=0 correct=0

  while IFS= read -r domain; do
    [[ -z "$domain" ]] && continue
    total=$((total + 1))

    local current_ip status
    current_ip=$(dig +short "$domain" A 2>/dev/null | head -1 || echo "-")

    if [[ "$current_ip" == "-" ]] || [[ -z "$current_ip" ]]; then
      status="✗"
      current_ip="-"
    elif [[ "$current_ip" == "$SERVER_IP" ]]; then
      status="✓"
      correct=$((correct + 1))
    else
      status="⚠"
    fi

    printf "%-35s %-6s %-15s\n" "$domain" "$status" "$current_ip"
  done < "$domains_file"

  echo
  echo "$correct/$total domains correct"
}

service-report-cmd "$@"

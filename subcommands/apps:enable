#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

service-apps-enable-cmd() {
  #E enable DNS management for an application
  #E dokku $PLUGIN_COMMAND_PREFIX:apps:enable nextcloud
  #E dokku $PLUGIN_COMMAND_PREFIX:apps:enable nextcloud example.com api.example.com
  #E dokku $PLUGIN_COMMAND_PREFIX:apps:enable nextcloud --ttl 3600
  #E dokku $PLUGIN_COMMAND_PREFIX:apps:enable nextcloud example.com --ttl 1800
  #E by default, adds all domains configured for the app
  #E optionally specify specific domains to add to DNS management
  #E optionally specify --ttl parameter to set custom TTL for these domains
  #E only domains with hosted zones in the DNS provider will be added
  #E this registers domains with the DNS provider but doesn't update records yet
  #E use 'dokku $PLUGIN_COMMAND_PREFIX:apps:sync' to update DNS records
  #A app, app to enable DNS management for
  #A domains, specific domains to add (optional, defaults to all app domains)
  #F --ttl, set custom TTL (time-to-live) in seconds for DNS records (60-86400)
  declare desc="enable DNS management for an application"
  local cmd="$PLUGIN_COMMAND_PREFIX:apps:enable" argv=("$@")
  [[ ${argv[0]} == "$cmd" ]] && shift 1
  declare APP="$1"
  shift 1 || true

  local TTL=""
  local DOMAINS=()

  while [[ $# -gt 0 ]]; do
    case $1 in
      --ttl) TTL="$2"; shift 2 ;;
      *) DOMAINS+=("$1"); shift ;;
    esac
  done

  [[ -z "$APP" ]] && { echo "Error: app name required"; return 1; }

  # Validate TTL
  if [[ -n "$TTL" ]]; then
    if ! [[ "$TTL" =~ ^[0-9]+$ ]] || [[ "$TTL" -lt 60 ]] || [[ "$TTL" -gt 86400 ]]; then
      echo "Error: TTL must be 60-86400 seconds"
      return 1
    fi
  fi

  # Get domains if not specified
  if [[ ${#DOMAINS[@]} -eq 0 ]]; then
    while IFS= read -r domain; do
      [[ -n "$domain" ]] && DOMAINS+=("$domain")
    done < <(get_app_domains "$APP")
  fi

  if [[ ${#DOMAINS[@]} -eq 0 ]]; then
    echo "No domains found for app '$APP'"
    return 1
  fi

  # Check which domains have enabled zones
  local valid_domains=()

  for domain in "${DOMAINS[@]}"; do
    if is_domain_in_enabled_zone "$domain"; then
      valid_domains+=("$domain")
    fi
  done

  if [[ ${#valid_domains[@]} -eq 0 ]]; then
    echo "No domains have enabled zones"
    echo "Enable zones with: dokku dns:zones:enable <zone>"
    return 1
  fi

  # Create app directory and save domains
  mkdir -p "$PLUGIN_DATA_ROOT/$APP"
  local domains_file="$PLUGIN_DATA_ROOT/$APP/DOMAINS"

  for domain in "${valid_domains[@]}"; do
    if ! grep -q "^$domain$" "$domains_file" 2>/dev/null; then
      echo "$domain" >> "$domains_file"
    fi
  done

  # Add to LINKS file
  local links_file="$PLUGIN_DATA_ROOT/LINKS"
  if ! grep -q "^$APP$" "$links_file" 2>/dev/null; then
    echo "$APP" >> "$links_file"
  fi

  # Save TTLs if specified
  if [[ -n "$TTL" ]]; then
    local ttls_file="$PLUGIN_DATA_ROOT/$APP/DOMAIN_TTLS"
    for domain in "${valid_domains[@]}"; do
      echo "$domain:$TTL" >> "$ttls_file"
    done
  fi

  echo "Enabled ${#valid_domains[@]} domain(s) for $APP"
  echo "Run 'dokku dns:apps:sync $APP' to create DNS records"
}

service-apps-enable-cmd "$@"

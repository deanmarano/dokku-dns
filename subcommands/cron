#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Load common fallback functions
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/common-functions"

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

validate_cron_schedule() {
  local schedule="$1"
  
  # Basic validation: check if it has 5 fields separated by spaces
  local field_count
  field_count=$(echo "$schedule" | wc -w)
  
  if [[ $field_count -ne 5 ]]; then
    dokku_log_fail "Invalid cron schedule: '$schedule'. Must have 5 fields (minute hour day month weekday)"
  fi
  
  # Extract fields
  local minute hour day month weekday
  read -r minute hour day month weekday <<< "$schedule"
  
  # Validate each field (basic checks)
  validate_cron_field "$minute" "0-59" "minute" "*,0-59"
  validate_cron_field "$hour" "0-23" "hour" "*,0-23"
  validate_cron_field "$day" "1-31" "day" "*,1-31"
  validate_cron_field "$month" "1-12" "month" "*,1-12"
  validate_cron_field "$weekday" "0-7" "weekday" "*,0-7"
}

validate_cron_field() {
  local field="$1"
  local range="$2"
  local field_name="$3"
  local valid_pattern="$4"
  
  # Allow wildcards, numbers, ranges, and lists
  if [[ "$field" =~ ^[\*0-9,/-]+$ ]]; then
    return 0
  else
    dokku_log_fail "Invalid $field_name field: '$field'. Must match pattern: $valid_pattern"
  fi
}

calculate_next_cron_run() {
  local schedule="$1"
  
  # Simple approximation for common cron patterns
  local minute hour day month weekday
  read -r minute hour day month weekday <<< "$schedule"
  
  # Get current time
  local now_epoch current_hour current_minute current_date
  now_epoch=$(date +%s)
  current_hour=$(date +%H | sed 's/^0*//')  
  current_minute=$(date +%M | sed 's/^0*//')
  current_date=$(date +%Y-%m-%d)
  
  # Handle simple daily patterns (0 HH * * *)
  if [[ "$minute" =~ ^[0-9]+$ ]] && [[ "$hour" =~ ^[0-9]+$ ]] && [[ "$day" == "*" ]] && [[ "$month" == "*" ]] && [[ "$weekday" == "*" ]]; then
    local target_hour target_minute
    target_hour=$((10#$hour))  # Force base 10 to handle leading zeros
    target_minute=$((10#$minute))
    
    # Calculate today's run time using portable date format
    local today_hour_24 today_minute_padded today_run
    today_hour_24=$(printf "%02d" $target_hour)
    today_minute_padded=$(printf "%02d" $target_minute)
    
    # Create timestamp for today at target time (portable approach)
    local target_time_str="$current_date $today_hour_24:$today_minute_padded:00"
    today_run=$(date -j -f "%Y-%m-%d %H:%M:%S" "$target_time_str" "+%s" 2>/dev/null || echo "0")
    
    # If today's run time has passed or is now, calculate tomorrow's run time
    if [[ $today_run -le $now_epoch ]]; then
      # Add 24 hours (86400 seconds) for tomorrow
      local tomorrow_epoch=$((today_run + 86400))
      local tomorrow_formatted
      tomorrow_formatted=$(date -r $tomorrow_epoch "+%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "")
      if [[ -n "$tomorrow_formatted" ]]; then
        echo "$tomorrow_formatted"
        return 0
      fi
    else
      # Today's run time hasn't passed yet
      local today_formatted
      today_formatted=$(date -r "$today_run" "+%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "")
      if [[ -n "$today_formatted" ]]; then
        echo "$today_formatted"
        return 0
      fi
    fi
  fi
  
  # For complex patterns, return a generic message
  return 1
}

# Helper functions for crontab management
get_crontab_cmd() {
  
  # Determine the appropriate crontab command based on current user and system
  local current_user
  current_user=$(id -un)
  
  if [[ "$current_user" == "root" ]] && id -u dokku >/dev/null 2>&1; then
    # Running as root and dokku user exists - use crontab -u to directly manage dokku's crontab
    # This avoids sudo authentication issues in containerized environments
    echo "crontab -u dokku"
    return 0
  elif [[ "$current_user" == "dokku" ]]; then
    # Running as dokku user - use direct crontab access
    echo "crontab"
    return 0
  else
    # Other user contexts - try sudo to dokku user
    if command -v sudo >/dev/null 2>&1 && id -u dokku >/dev/null 2>&1 && sudo -u dokku true >/dev/null 2>&1 && sudo -u dokku crontab -l >/dev/null 2>&1; then
      echo "sudo -u dokku crontab"
      return 0
    fi
    
    # If no dokku user access, fall back to current user
    echo "crontab"
  fi
}

list_cron_jobs() {
  local crontab_cmd
  crontab_cmd=$(get_crontab_cmd)
  
  if [[ "$crontab_cmd" == "crontab -u dokku" ]]; then
    crontab -u dokku -l 2>/dev/null
  elif [[ "$crontab_cmd" == "sudo -u dokku crontab" ]]; then
    sudo -u dokku crontab -l 2>/dev/null
  elif [[ "$crontab_cmd" == "su dokku -c 'crontab" ]]; then
    su dokku -c 'crontab -l 2>/dev/null' 2>/dev/null
  else
    crontab -l 2>/dev/null
  fi
}

install_cron_job() {
  local entry="$1"
  local crontab_cmd
  crontab_cmd=$(get_crontab_cmd)
  
  if [[ "$crontab_cmd" == "crontab -u dokku" ]]; then
    if ! (crontab -u dokku -l 2>/dev/null || echo "") | { cat; echo "$entry"; } | crontab -u dokku - 2>/dev/null; then
      return 1
    fi
  elif [[ "$crontab_cmd" == "sudo -u dokku crontab" ]]; then
    if ! (sudo -u dokku crontab -l 2>/dev/null || echo "") | { cat; echo "$entry"; } | sudo -u dokku crontab - 2>/dev/null; then
      return 1
    fi
  elif [[ "$crontab_cmd" == "su dokku -c 'crontab" ]]; then
    if ! (su dokku -c 'crontab -l 2>/dev/null' 2>/dev/null || echo "") | { cat; echo "$entry"; } | su dokku -c 'crontab -' 2>/dev/null; then
      return 1
    fi
  else
    if ! (crontab -l 2>/dev/null || echo "") | { cat; echo "$entry"; } | crontab - 2>/dev/null; then
      return 1
    fi
  fi
  return 0
}

remove_cron_jobs() {
  local pattern="$1"
  local crontab_cmd
  crontab_cmd=$(get_crontab_cmd)
  
  if [[ "$crontab_cmd" == "crontab -u dokku" ]]; then
    if ! (crontab -u dokku -l 2>/dev/null || echo "") | (grep -v "$pattern" || true) | crontab -u dokku - 2>/dev/null; then
      return 1
    fi
  elif [[ "$crontab_cmd" == "sudo -u dokku crontab" ]]; then
    if ! (sudo -u dokku crontab -l 2>/dev/null || echo "") | (grep -v "$pattern" || true) | sudo -u dokku crontab - 2>/dev/null; then
      return 1
    fi
  elif [[ "$crontab_cmd" == "su dokku -c 'crontab" ]]; then
    if ! (su dokku -c 'crontab -l 2>/dev/null' 2>/dev/null || echo "") | (grep -v "$pattern" || true) | su dokku -c 'crontab -' 2>/dev/null; then
      return 1
    fi
  else
    if ! (crontab -l 2>/dev/null || echo "") | (grep -v "$pattern" || true) | crontab - 2>/dev/null; then
      return 1
    fi
  fi
  return 0
}

service-cron-cmd() {
  #E manage automated DNS synchronization cron job
  #E dokku $PLUGIN_COMMAND_PREFIX:cron [--enable|--disable|--schedule "CRON_SCHEDULE"]
  #E without flags: displays current cron job status, schedule, last run time,
  #E and recent log entries from automated DNS synchronization.
  #E --enable: creates a system cron job that runs dns:sync-all daily at 2:00 AM (default)
  #E --disable: removes the cron job while preserving logs and metadata
  #E --schedule: specify custom cron schedule and enable cron job (e.g., "0 4 * * *" for 4 AM daily)
  #F --enable, enable automated DNS synchronization via cron (default: daily at 2:00 AM)
  #F --disable, disable automated DNS synchronization cron job
  #F --schedule, specify custom cron schedule and enable cron job (e.g., "0 4 * * *")
  declare desc="manage automated DNS synchronization cron job"
  local cmd="$PLUGIN_COMMAND_PREFIX:cron" argv=("$@")
  
  # Handle Dokku command routing - first argument will be the command name
  if [[ "$1" == "$cmd" ]]; then
    shift 1
  fi
  
  # Parse arguments
  local enable_cron=false
  local disable_cron=false
  local custom_schedule=""
  
  while [[ $# -gt 0 ]]; do
    case $1 in
      --enable)
        enable_cron=true
        shift
        ;;
      --disable)
        disable_cron=true
        shift
        ;;
      --schedule)
        if [[ -z "$2" ]]; then
          dokku_log_fail "--schedule requires a cron schedule argument (e.g., \"0 4 * * *\")"
        fi
        custom_schedule="$2"
        shift 2
        ;;
      *)
        echo "unknown flag: $1" >&2
        echo "Usage of $PLUGIN_COMMAND_PREFIX:cron:" >&2
        echo "  dokku $PLUGIN_COMMAND_PREFIX:cron [--enable|--disable|--schedule \"SCHEDULE\"]" >&2
        exit 2
        ;;
    esac
  done
  
  # Auto-enable when schedule is provided
  if [[ -n "$custom_schedule" ]]; then
    enable_cron=true
  fi
  
  # Validate flag combinations
  if [[ "$enable_cron" == "true" && "$disable_cron" == "true" ]]; then
    dokku_log_fail "Cannot use both --enable and --disable flags together."
  fi
  
  # Execute actions
  if [[ "$enable_cron" == "true" ]]; then
    cron_enable_functionality "$custom_schedule"
    return $?
  elif [[ "$disable_cron" == "true" ]]; then
    cron_disable_functionality
    return $?
  fi
  
  # Default: show status (original functionality)
  
  local CRON_DATA_DIR="$PLUGIN_DATA_ROOT/cron"
  
  echo
  dokku_log_info2 "DNS Cron Status"
  
  # Check if cron job exists in crontab
  local cron_job_active=false
  local current_job=""
  if list_cron_jobs | grep -q "dokku dns:sync-all"; then
    cron_job_active=true
    current_job=$(list_cron_jobs | grep "dokku dns:sync-all" | head -1)
  fi
  
  # Check metadata status
  local status="unknown"
  local schedule="N/A"
  local command="N/A"
  local log_file="N/A"
  local enabled_at="N/A"
  local disabled_at="N/A"
  
  if [[ -d "$CRON_DATA_DIR" ]]; then
    [[ -f "$CRON_DATA_DIR/status" ]] && status=$(cat "$CRON_DATA_DIR/status")
    [[ -f "$CRON_DATA_DIR/schedule" ]] && schedule=$(cat "$CRON_DATA_DIR/schedule")
    [[ -f "$CRON_DATA_DIR/command" ]] && command=$(cat "$CRON_DATA_DIR/command")
    [[ -f "$CRON_DATA_DIR/log_file" ]] && log_file=$(cat "$CRON_DATA_DIR/log_file")
    [[ -f "$CRON_DATA_DIR/enabled_at" ]] && enabled_at=$(cat "$CRON_DATA_DIR/enabled_at")
    [[ -f "$CRON_DATA_DIR/disabled_at" ]] && disabled_at=$(cat "$CRON_DATA_DIR/disabled_at")
  fi
  
  # Display status
  if [[ "$cron_job_active" == "true" ]]; then
    dokku_log_info1 "Status: ENABLED"
    dokku_log_info1 "Active Job: $current_job"
    
    # Calculate and display next run time
    if [[ "$schedule" != "N/A" ]]; then
      local next_run
      next_run=$(calculate_next_cron_run "$schedule" 2>/dev/null || echo "Unable to calculate")
      if [[ "$next_run" != "Unable to calculate" ]]; then
        dokku_log_info1 "Next Run: $next_run"
      fi
    fi
  else
    dokku_log_info1 "Status: DISABLED"
  fi
  
  # Display configuration
  echo
  dokku_log_info2 "Configuration"
  if [[ "$schedule" == "0 2 * * *" ]]; then
    dokku_log_info1 "Schedule: $schedule (Daily at 2:00 AM - default)"
  else
    dokku_log_info1 "Schedule: $schedule (custom)"
  fi
  dokku_log_info1 "Command: $command"
  dokku_log_info1 "Log File: $log_file"
  
  # Display timestamps
  echo
  dokku_log_info2 "History"
  if [[ "$enabled_at" != "N/A" ]]; then
    dokku_log_info1 "Enabled At: $enabled_at"
  fi
  if [[ "$disabled_at" != "N/A" ]]; then
    dokku_log_info1 "Disabled At: $disabled_at"
  fi
  
  # Display log file information and recent entries
  echo
  dokku_log_info2 "Log Information"
  
  if [[ -f "$log_file" && "$log_file" != "N/A" ]]; then
    local log_size
    log_size=$(wc -l < "$log_file" 2>/dev/null | xargs || echo "0")
    local log_modified
    log_modified=$(stat -c %y "$log_file" 2>/dev/null || echo "Unknown")
    
    dokku_log_info1 "Log Entries: $log_size lines"
    dokku_log_info1 "Last Modified: $log_modified"
    
    echo
    dokku_log_info2 "Recent Log Entries (last 10 lines)"
    if [[ -s "$log_file" ]]; then
      tail -n 10 "$log_file" | while IFS= read -r line; do
        echo "  $line"
      done
    else
      dokku_log_info1 "  (No log entries yet)"
    fi
  else
    dokku_log_info1 "Log File: Not found or not configured"
  fi
  
}

cron_enable_functionality() {
  local custom_schedule="$1"
  local CRON_DATA_DIR="$PLUGIN_DATA_ROOT/cron"
  local CRON_SCHEDULE="${custom_schedule:-0 2 * * *}"  # Default to daily at 2 AM
  local CRON_COMMAND="dokku dns:sync-all"
  local CRON_LOG_FILE="$CRON_DATA_DIR/sync.log"
  local CRON_JOB_COMMENT="# Dokku DNS auto-sync"
  local CRON_ENTRY="$CRON_SCHEDULE $CRON_COMMAND >> $CRON_LOG_FILE 2>&1 $CRON_JOB_COMMENT"
  
  # Validate custom schedule if provided
  if [[ -n "$custom_schedule" ]]; then
    validate_cron_schedule "$custom_schedule"
  fi
  
  # Check if DNS provider is configured
  
  # Create cron data directory
  mkdir -p "$CRON_DATA_DIR"
  
  # Check if cron job already exists and remove it
  local is_update=false
  if list_cron_jobs | grep -q "dokku dns:sync-all"; then
    local existing_job existing_schedule
    existing_job=$(list_cron_jobs | grep "dokku dns:sync-all" | head -1)
    existing_schedule=$(echo "$existing_job" | awk '{print $1, $2, $3, $4, $5}')
    is_update=true
    
    echo
    dokku_log_info2 "Updating DNS Cron Job"
    dokku_log_info1 "Previous: $existing_schedule"
    if [[ "$CRON_SCHEDULE" == "0 2 * * *" ]]; then
      dokku_log_info1 "New: $CRON_SCHEDULE (Daily at 2:00 AM - default)"
    else
      dokku_log_info1 "New: $CRON_SCHEDULE (custom)"
    fi
    
    # Remove existing cron job
    remove_cron_jobs "dokku dns:sync-all"
  else
    echo
    dokku_log_info2 "Creating DNS Cron Job"
    if [[ "$CRON_SCHEDULE" == "0 2 * * *" ]]; then
      dokku_log_info1 "Schedule: $CRON_SCHEDULE (Daily at 2:00 AM - default)"
    else
      dokku_log_info1 "Schedule: $CRON_SCHEDULE (custom)"
    fi
  fi
  
  # Add cron job to crontab
  if ! install_cron_job "$CRON_ENTRY"; then
    dokku_log_fail "Failed to install cron job. Permission denied - try running with sudo:\n  sudo dokku $PLUGIN_COMMAND_PREFIX:cron --enable"
  fi
  
  if list_cron_jobs | grep -q "dokku dns:sync-all"; then
    # Store cron job metadata
    echo "enabled" > "$CRON_DATA_DIR/status"
    echo "$CRON_SCHEDULE" > "$CRON_DATA_DIR/schedule"
    echo "$CRON_COMMAND" > "$CRON_DATA_DIR/command"
    echo "$CRON_LOG_FILE" > "$CRON_DATA_DIR/log_file"
    date +%Y-%m-%d\ %H:%M:%S > "$CRON_DATA_DIR/enabled_at"
    
    # Initialize log file
    echo "$(date): DNS cron job enabled" > "$CRON_LOG_FILE"

    if [[ "$is_update" == "true" ]]; then
      dokku_log_info1 "DNS cron job updated"
    else
      dokku_log_info1 "DNS cron job enabled"
    fi
  else
    dokku_log_fail "Failed to create DNS cron job. Check system permissions."
  fi
}

cron_disable_functionality() {
  local CRON_DATA_DIR="$PLUGIN_DATA_ROOT/cron"
  
  # Check if cron job exists
  if ! list_cron_jobs | grep -q "dokku dns:sync-all"; then
    dokku_log_fail "No DNS cron job found. Enable with: dokku $PLUGIN_COMMAND_PREFIX:cron --enable"
  fi
  
  echo
  dokku_log_info2 "Disabling DNS Cron Job"
  
  # Show current schedule before removing
  local current_job current_schedule
  current_job=$(list_cron_jobs | grep "dokku dns:sync-all" | head -1)
  if [[ -n "$current_job" ]]; then
    current_schedule=$(echo "$current_job" | awk '{print $1, $2, $3, $4, $5}')
    if [[ "$current_schedule" == "0 2 * * *" ]]; then
      dokku_log_info1 "Current: $current_schedule (Daily at 2:00 AM - default)"
    else
      dokku_log_info1 "Current: $current_schedule (custom)"
    fi
  fi
  
  # Remove the cron job from crontab
  if ! remove_cron_jobs "dokku dns:sync-all"; then
    dokku_log_fail "Failed to remove cron job. Permission denied - try running with sudo:\n  sudo dokku $PLUGIN_COMMAND_PREFIX:cron --disable"
  fi
  
  # Verify removal
  if list_cron_jobs | grep -q "dokku dns:sync-all"; then
    dokku_log_fail "Failed to remove DNS cron job. Permission denied - try running with sudo:\n  sudo dokku $PLUGIN_COMMAND_PREFIX:cron --disable"
  fi
  
  # Update status metadata
  if [[ -d "$CRON_DATA_DIR" ]]; then
    echo "disabled" > "$CRON_DATA_DIR/status"
    date +%Y-%m-%d\ %H:%M:%S > "$CRON_DATA_DIR/disabled_at"
    
    # Add log entry about disabling
    local CRON_LOG_FILE
    if [[ -f "$CRON_DATA_DIR/log_file" ]]; then
      CRON_LOG_FILE=$(cat "$CRON_DATA_DIR/log_file")
      echo "$(date): DNS cron job disabled" >> "$CRON_LOG_FILE"
    fi
  fi
  
  dokku_log_info1 "DNS cron job disabled"
}

service-cron-cmd "$@"
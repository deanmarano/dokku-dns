#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Define missing functions if needed
if ! declare -f dokku_log_info1 >/dev/null 2>&1; then
  dokku_log_info1() { echo "-----> $*"; }
fi

if ! declare -f dokku_log_info2 >/dev/null 2>&1; then
  dokku_log_info2() { echo "=====> $*"; }
fi

if ! declare -f dokku_log_warn >/dev/null 2>&1; then
  dokku_log_warn() { echo " !     $*"; }
fi

if ! declare -f dokku_log_fail >/dev/null 2>&1; then
  dokku_log_fail() { echo " !     $*" >&2; exit 1; }
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

# Load multi-provider system
MULTI_PROVIDER_PATH="$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/providers/multi-provider.sh"
if [[ -f "$MULTI_PROVIDER_PATH" ]]; then
  source "$MULTI_PROVIDER_PATH"
fi

service-zones-cmd() {
  #E list DNS zones and their auto-discovery status
  #E dokku $PLUGIN_COMMAND_PREFIX:zones [<zone>]
  #E without arguments: displays all available DNS zones and their auto-discovery status
  #E <zone>: show detailed information about a specific zone
  #E use 'dokku $PLUGIN_COMMAND_PREFIX:zones:enable' to enable auto-discovery for zones
  #E use 'dokku $PLUGIN_COMMAND_PREFIX:zones:disable' to disable auto-discovery for zones
  #A zone, zone name to show detailed information for (optional)
  declare desc="list DNS zones and their auto-discovery status"
  local cmd="$PLUGIN_COMMAND_PREFIX:zones" argv=("$@")

  # Handle Dokku command routing - first argument will be the command name
  if [[ "$1" == "$cmd" ]]; then
    shift 1
  fi

  declare ZONE=""

  # Check for any flags (which are no longer supported)
  while [[ $# -gt 0 ]]; do
    case $1 in
      --*)
        dokku_log_fail "Flags are no longer supported. Use 'dokku $PLUGIN_COMMAND_PREFIX:zones:enable' or 'dokku $PLUGIN_COMMAND_PREFIX:zones:disable' instead."
        ;;
      *)
        if [[ -z "$ZONE" ]]; then
          ZONE="$1"
        else
          dokku_log_fail "Unknown option: $1. Use <zone> or no arguments for status listing."
        fi
        shift
        ;;
    esac
  done

  # Execute actions
  if [[ -n "$ZONE" ]]; then
    zones_show_zone "$ZONE"
  else
    zones_list_status
  fi
}

zones_list_status() {
  echo
  dokku_log_info2 "DNS Zones Status"

  # Load provider loader system
  local LOADER_PATH
  LOADER_PATH="$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/providers/loader.sh"
  if [[ ! -f "$LOADER_PATH" ]]; then
    dokku_log_fail "Provider loader system not found"
  fi
  source "$LOADER_PATH"

  # Get all available providers
  local available_providers=()
  while IFS= read -r provider; do
    available_providers+=("$provider")
  done < <(get_available_providers)

  # Check each provider and list zones
  local working_providers=0
  for provider in "${available_providers[@]}"; do
    # Skip test-only providers in normal mode
    if [[ "$provider" =~ ^(template|mock)$ ]] && [[ -z "${DNS_TEST_MODE:-}" ]]; then
      continue
    fi

    # Try to load and validate the provider
    if load_provider "$provider" 2>/dev/null; then
      if provider_validate_credentials 2>/dev/null; then
        zones_list_provider_zones "$provider"
        working_providers=$((working_providers + 1))
      fi
    fi
  done

  if [[ $working_providers -eq 0 ]]; then
    dokku_log_info1 "No DNS providers configured with valid credentials"
    echo
    dokku_log_info2 "Setup Instructions"
    dokku_log_info1 "Run: dokku $PLUGIN_COMMAND_PREFIX:providers:verify"
    dokku_log_info1 "This will show detailed setup instructions for each provider"
  fi
}

zones_list_provider_zones() {
  local provider_name="$1"

  echo
  dokku_log_info2 "Provider: $provider_name"

  # Get zones from provider
  local zones_list
  if ! zones_list=$(provider_list_zones 2>/dev/null); then
    dokku_log_info1 "  No zones found or failed to retrieve zones"
    return 0
  fi

  local zone_count
  zone_count=$(echo "$zones_list" | wc -l)

  if [[ -z "$zones_list" ]] || [[ "$zone_count" -eq 0 ]]; then
    dokku_log_info1 "  No zones found for this provider"
    return 0
  fi

  # Get managed apps for comparison
  local LINKS_FILE="$PLUGIN_DATA_ROOT/LINKS"
  local MANAGED_APPS=""
  if [[ -f "$LINKS_FILE" ]]; then
    MANAGED_APPS=$(cat "$LINKS_FILE" 2>/dev/null || echo "")
  fi

  # Get all managed domains
  local ALL_MANAGED_DOMAINS=""
  if [[ -n "$MANAGED_APPS" ]]; then
    while IFS= read -r app; do
      [[ -z "$app" ]] && continue
      local APP_DOMAINS_FILE="$PLUGIN_DATA_ROOT/$app/DOMAINS"
      if [[ -f "$APP_DOMAINS_FILE" ]]; then
        local APP_DOMAINS
        APP_DOMAINS=$(cat "$APP_DOMAINS_FILE" 2>/dev/null || echo "")
        ALL_MANAGED_DOMAINS="$ALL_MANAGED_DOMAINS $APP_DOMAINS"
      fi
    done <<< "$MANAGED_APPS"
  fi

  # Display zones
  while IFS= read -r zone_name; do
    [[ -z "$zone_name" ]] && continue

    # Get zone ID for this zone
    local zone_id
    zone_id=$(provider_get_zone_id "$zone_name" 2>/dev/null || echo "")

    # Check if any managed domains belong to this zone
    local managed_in_zone=0
    local zone_domains=""

    if [[ -n "$ALL_MANAGED_DOMAINS" ]]; then
      for domain in $ALL_MANAGED_DOMAINS; do
        # Check if domain matches this zone exactly or is a subdomain
        if [[ "$domain" == "$zone_name" ]] || [[ "$domain" == *".$zone_name" ]]; then
          managed_in_zone=$((managed_in_zone + 1))
          if [[ -n "$zone_domains" ]]; then
            zone_domains="$zone_domains, $domain"
          else
            zone_domains="$domain"
          fi
        fi
      done
    fi

    # Check if zone is enabled
    local zone_enabled_status="DISABLED"
    if is_zone_enabled "$zone_name"; then
      zone_enabled_status="ENABLED"
    fi

    # Display zone info
    echo
    if [[ $managed_in_zone -gt 0 ]]; then
      if [[ -n "$zone_id" ]]; then
        dokku_log_info1 "  $zone_enabled_status $zone_name ($zone_id) - ACTIVE"
      else
        dokku_log_info1 "  $zone_enabled_status $zone_name - ACTIVE"
      fi
      dokku_log_info1 "     Managed domains ($managed_in_zone): $zone_domains"
    else
      if [[ -n "$zone_id" ]]; then
        dokku_log_info1 "  $zone_enabled_status $zone_name ($zone_id) - available"
      else
        dokku_log_info1 "  $zone_enabled_status $zone_name - available"
      fi
    fi
  done <<< "$zones_list"

  echo
}

zones_show_zone() {
  local ZONE="$1"

  echo
  dokku_log_info2 "DNS Zone Details: $ZONE"

  # Load provider loader system
  local LOADER_PATH
  LOADER_PATH="$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/providers/loader.sh"
  if [[ ! -f "$LOADER_PATH" ]]; then
    dokku_log_fail "Provider loader system not found"
  fi
  source "$LOADER_PATH"

  # Find which provider manages this zone
  local zone_provider=""
  local zone_id=""

  # Try each available provider
  local available_providers=()
  while IFS= read -r provider; do
    available_providers+=("$provider")
  done < <(get_available_providers)

  for provider in "${available_providers[@]}"; do
    # Skip test-only providers in normal mode
    if [[ "$provider" =~ ^(template|mock)$ ]] && [[ -z "${DNS_TEST_MODE:-}" ]]; then
      continue
    fi

    # Try to load and validate the provider
    if load_provider "$provider" 2>/dev/null; then
      if provider_validate_credentials 2>/dev/null; then
        # Check if this provider has the zone
        local temp_zone_id
        temp_zone_id=$(provider_get_zone_id "$ZONE" 2>/dev/null || echo "")
        if [[ -n "$temp_zone_id" ]]; then
          zone_provider="$provider"
          zone_id="$temp_zone_id"
          break
        fi
      fi
    fi
  done

  if [[ -z "$zone_provider" ]]; then
    dokku_log_fail "Zone '$ZONE' not found in any configured provider"
  fi

  dokku_log_info1 "Provider: $zone_provider"
  dokku_log_info1 "Zone ID: $zone_id"

  # Get Dokku app associations first
  echo
  dokku_log_info2 "Dokku Integration"
  
  # Get all managed apps and their domains
  local LINKS_FILE="$PLUGIN_DATA_ROOT/LINKS"
  local zone_apps=()
  local zone_domains=()
  
  if [[ -f "$LINKS_FILE" ]]; then
    while IFS= read -r app; do
      [[ -z "$app" ]] && continue
      
      local APP_DOMAINS_FILE="$PLUGIN_DATA_ROOT/$app/DOMAINS"
      if [[ -f "$APP_DOMAINS_FILE" ]]; then
        while IFS= read -r domain; do
          [[ -z "$domain" ]] && continue
          
          # Check if domain belongs to this zone
          if [[ "$domain" == "$ZONE" ]] || [[ "$domain" == *".$ZONE" ]]; then
            zone_apps+=("$app")
            zone_domains+=("$domain")
          fi
        done < "$APP_DOMAINS_FILE"
      fi
    done < "$LINKS_FILE"
  fi
  
  if [[ ${#zone_domains[@]} -gt 0 ]]; then
    dokku_log_info1 "Managed Domains: ${#zone_domains[@]}"
    local i=0
    for domain in "${zone_domains[@]}"; do
      local app="${zone_apps[$i]}"
      echo "  - $domain (app: $app)"
      i=$((i + 1))
    done
  else
    dokku_log_info1 "No domains managed in this zone"
  fi
  
  # Show potential domains from Dokku apps
  echo
  dokku_log_info2 "Potential Dokku Domains"
  
  # Get all domains from all Dokku apps that could belong to this zone
  local potential_domains=()
  local APPS_LIST
  APPS_LIST=$(dokku apps:list 2>/dev/null | grep -v "====>" || echo "")
  
  if [[ -n "$APPS_LIST" ]]; then
    while IFS= read -r app; do
      [[ -z "$app" ]] && continue
      local APP_DOMAINS
      APP_DOMAINS=$(dokku domains:report "$app" --domains-app-vhosts 2>/dev/null || echo "")
      if [[ -n "$APP_DOMAINS" ]]; then
        for domain in $APP_DOMAINS; do
          # Check if domain belongs to this zone but is not managed
          if [[ "$domain" == "$ZONE" ]] || [[ "$domain" == *".$ZONE" ]]; then
            # Check if it's already managed
            local already_managed=false
            for managed_domain in "${zone_domains[@]}"; do
              if [[ "$domain" == "$managed_domain" ]]; then
                already_managed=true
                break
              fi
            done
            
            if [[ "$already_managed" == "false" ]]; then
              potential_domains+=("$domain:$app")
            fi
          fi
        done
      fi
    done <<< "$APPS_LIST"
  fi
  
  if [[ ${#potential_domains[@]} -gt 0 ]]; then
    dokku_log_info1 "Unmanaged domains that could be added:"
    for domain_app in "${potential_domains[@]}"; do
      local domain="${domain_app%:*}"
      local app="${domain_app#*:}"
      echo "  â€¢ $domain (app: $app)"
    done
  else
    dokku_log_info1 "All potential domains for this zone are already managed"
  fi

  echo
  dokku_log_info2 "Management Commands"
  dokku_log_info1 "Enable zone: dokku $PLUGIN_COMMAND_PREFIX:zones:enable $ZONE"
  dokku_log_info1 "Disable zone: dokku $PLUGIN_COMMAND_PREFIX:zones:disable $ZONE"
  if [[ ${#potential_domains[@]} -gt 0 ]]; then
    dokku_log_info1 "Add domains: dokku $PLUGIN_COMMAND_PREFIX:apps:enable <app>"
  fi
  echo
}

service-zones-cmd "$@"
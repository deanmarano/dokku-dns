#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

# Load multi-provider system
PROVIDERS_DIR="$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/providers"
source "$PROVIDERS_DIR/multi-provider.sh"

service-zones-cmd() {
  #E list DNS zones and their auto-discovery status
  #E dokku $PLUGIN_COMMAND_PREFIX:zones [<zone>]
  #E without arguments: displays all available DNS zones and their auto-discovery status
  #E <zone>: show detailed information about a specific zone
  #E use 'dokku $PLUGIN_COMMAND_PREFIX:zones:enable' to enable auto-discovery for zones
  #E use 'dokku $PLUGIN_COMMAND_PREFIX:zones:disable' to disable auto-discovery for zones
  #A zone, zone name to show detailed information for (optional)
  declare desc="list DNS zones and their auto-discovery status"
  local cmd="$PLUGIN_COMMAND_PREFIX:zones" argv=("$@")
  
  # Handle Dokku command routing - first argument will be the command name
  if [[ "$1" == "$cmd" ]]; then
    shift 1
  fi
  
  declare ZONE=""
  
  # Check for any flags (which are no longer supported)
  while [[ $# -gt 0 ]]; do
    case $1 in
      --*)
        dokku_log_fail "Flags are no longer supported. Use 'dokku $PLUGIN_COMMAND_PREFIX:zones:enable' or 'dokku $PLUGIN_COMMAND_PREFIX:zones:disable' instead."
        ;;
      *)
        if [[ -z "$ZONE" ]]; then
          ZONE="$1"
        else
          dokku_log_fail "Unknown option: $1. Use <zone> or no arguments for status listing."
        fi
        shift
        ;;
    esac
  done
  
  # Execute actions
  if [[ -n "$ZONE" ]]; then
    zones_show_zone "$ZONE"
  else
    zones_list_status
  fi
}

zones_list_status() {
  echo
  dokku_log_info2 "DNS Zones Status (All Providers)"

  if ! discover_all_providers 2>/dev/null; then
    echo
    dokku_log_warn "No DNS providers configured or accessible"
    echo
    dokku_log_info2 "Management Commands"
    dokku_log_info1 "• Verify provider setup: dokku $PLUGIN_COMMAND_PREFIX:providers:verify"
    return 0
  fi

  zones_list_all_zones
}

zones_list_all_zones() {
  # Get managed apps for comparison
  local LINKS_FILE="$PLUGIN_DATA_ROOT/LINKS"
  local MANAGED_APPS=""
  if [[ -f "$LINKS_FILE" ]]; then
    MANAGED_APPS=$(cat "$LINKS_FILE" 2>/dev/null || echo "")
  fi

  # Get all managed domains
  local ALL_MANAGED_DOMAINS=""
  if [[ -n "$MANAGED_APPS" ]]; then
    while IFS= read -r app; do
      [[ -z "$app" ]] && continue
      local APP_DOMAINS_FILE="$PLUGIN_DATA_ROOT/$app/DOMAINS"
      if [[ -f "$APP_DOMAINS_FILE" ]]; then
        local APP_DOMAINS
        APP_DOMAINS=$(cat "$APP_DOMAINS_FILE" 2>/dev/null || echo "")
        ALL_MANAGED_DOMAINS="$ALL_MANAGED_DOMAINS $APP_DOMAINS"
      fi
    done <<< "$MANAGED_APPS"
  fi

  # Iterate through all discovered providers
  local total_zones=0
  for provider_file in "$MULTI_PROVIDER_DATA/providers"/*; do
    [[ ! -f "$provider_file" ]] && continue

    local provider_name
    provider_name=$(basename "$provider_file")

    # Load this provider
    if ! load_provider "$provider_name" 2>/dev/null; then
      continue
    fi

    # Get zones for this provider
    local zones
    zones=$(cat "$provider_file" 2>/dev/null)
    [[ -z "$zones" ]] && continue

    echo
    dokku_log_info2 "Provider: $provider_name"

    # Display each zone
    while IFS= read -r zone_name; do
      [[ -z "$zone_name" ]] && continue
      total_zones=$((total_zones + 1))

      # Get zone ID from provider
      local zone_id
      zone_id=$(provider_get_zone_id "$zone_name" 2>/dev/null || echo "unknown")

      # Check if any managed domains belong to this zone
      local managed_in_zone=0
      local zone_domains=""

      if [[ -n "$ALL_MANAGED_DOMAINS" ]]; then
        for domain in $ALL_MANAGED_DOMAINS; do
          # Check if domain matches this zone exactly or is a subdomain
          if [[ "$domain" == "$zone_name" ]] || [[ "$domain" == *".$zone_name" ]]; then
            managed_in_zone=$((managed_in_zone + 1))
            if [[ -n "$zone_domains" ]]; then
              zone_domains="$zone_domains, $domain"
            else
              zone_domains="$domain"
            fi
          fi
        done
      fi

      # Check if zone is enabled
      local zone_enabled_status="DISABLED"
      if is_zone_enabled "$zone_name"; then
        zone_enabled_status="ENABLED"
      fi

      # Display zone info
      echo
      if [[ $managed_in_zone -gt 0 ]]; then
        dokku_log_info1 "$zone_enabled_status $zone_name ($zone_id) - ACTIVE"
        dokku_log_info1 "   Managed domains ($managed_in_zone): $zone_domains"
      else
        dokku_log_info1 "$zone_enabled_status $zone_name ($zone_id) - available"
      fi
    done <<< "$zones"
  done

  if [[ $total_zones -eq 0 ]]; then
    echo
    dokku_log_info1 "No zones found across any configured providers"
  fi
}

zones_show_zone() {
  local ZONE="$1"

  if ! discover_all_providers 2>/dev/null; then
    dokku_log_fail "No DNS providers configured or accessible"
  fi

  # Find provider for this zone
  # Note: || true is required because with set -eo pipefail, command substitution
  # in assignments will exit if the command returns non-zero. find_provider_for_zone
  # returns 1 when zone is not found, which is a valid case we handle below.
  local PROVIDER
  PROVIDER=$(find_provider_for_zone "$ZONE" 2>/dev/null || true)

  if [[ -z "$PROVIDER" ]]; then
    dokku_log_fail "Zone '$ZONE' not found in any configured provider"
  fi

  # Load the provider
  if ! load_provider "$PROVIDER" 2>/dev/null; then
    dokku_log_fail "Failed to load provider: $PROVIDER"
  fi

  echo
  dokku_log_info2 "DNS Zone Details: $ZONE"

  # Get zone ID from provider
  local ZONE_ID
  ZONE_ID=$(provider_get_zone_id "$ZONE" 2>/dev/null)

  if [[ -z "$ZONE_ID" ]]; then
    dokku_log_fail "Failed to get zone ID for '$ZONE' from provider $PROVIDER"
  fi
  
  # Get Dokku app associations first
  echo
  dokku_log_info2 "Dokku Integration"
  
  # Get all managed apps and their domains
  local LINKS_FILE="$PLUGIN_DATA_ROOT/LINKS"
  local zone_apps=()
  local zone_domains=()
  
  if [[ -f "$LINKS_FILE" ]]; then
    while IFS= read -r app; do
      [[ -z "$app" ]] && continue
      
      local APP_DOMAINS_FILE="$PLUGIN_DATA_ROOT/$app/DOMAINS"
      if [[ -f "$APP_DOMAINS_FILE" ]]; then
        while IFS= read -r domain; do
          [[ -z "$domain" ]] && continue
          
          # Check if domain belongs to this zone
          if [[ "$domain" == "$ZONE" ]] || [[ "$domain" == *".$ZONE" ]]; then
            zone_apps+=("$app")
            zone_domains+=("$domain")
          fi
        done < "$APP_DOMAINS_FILE"
      fi
    done < "$LINKS_FILE"
  fi
  
  if [[ ${#zone_domains[@]} -gt 0 ]]; then
    dokku_log_info1 "Managed Domains: ${#zone_domains[@]}"
    local i=0
    for domain in "${zone_domains[@]}"; do
      local app="${zone_apps[$i]}"
      echo "  - $domain (app: $app)"
      i=$((i + 1))
    done
  else
    dokku_log_info1 "No domains managed in this zone"
  fi
  
  # Show potential domains from Dokku apps
  echo
  dokku_log_info2 "Potential Dokku Domains"
  
  # Get all domains from all Dokku apps that could belong to this zone
  local potential_domains=()
  local APPS_LIST
  APPS_LIST=$(dokku apps:list 2>/dev/null | grep -v "====>" || echo "")
  
  if [[ -n "$APPS_LIST" ]]; then
    while IFS= read -r app; do
      [[ -z "$app" ]] && continue
      local APP_DOMAINS
      APP_DOMAINS=$(dokku domains:report "$app" --domains-app-vhosts 2>/dev/null || echo "")
      if [[ -n "$APP_DOMAINS" ]]; then
        for domain in $APP_DOMAINS; do
          # Check if domain belongs to this zone but is not managed
          if [[ "$domain" == "$ZONE" ]] || [[ "$domain" == *".$ZONE" ]]; then
            # Check if it's already managed
            local already_managed=false
            for managed_domain in "${zone_domains[@]}"; do
              if [[ "$domain" == "$managed_domain" ]]; then
                already_managed=true
                break
              fi
            done
            
            if [[ "$already_managed" == "false" ]]; then
              potential_domains+=("$domain:$app")
            fi
          fi
        done
      fi
    done <<< "$APPS_LIST"
  fi
  
  if [[ ${#potential_domains[@]} -gt 0 ]]; then
    dokku_log_info1 "Unmanaged domains that could be added:"
    for domain_app in "${potential_domains[@]}"; do
      local domain="${domain_app%:*}"
      local app="${domain_app#*:}"
      echo "  • $domain (app: $app)"
    done
  else
    dokku_log_info1 "All potential domains for this zone are already managed"
  fi
  
  # Show provider technical details
  echo
  dokku_log_info2 "Provider Information"

  dokku_log_info1 "Zone ID: $ZONE_ID"
  dokku_log_info1 "Zone Name: $ZONE"
  dokku_log_info1 "Provider: $PROVIDER"

  # Note: Detailed zone information (record count, nameservers, etc.) varies by provider
  # Providers can implement provider_get_zone_details() for additional information

}

service-zones-cmd "$@"
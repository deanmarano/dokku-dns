#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load dokku functions
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Define missing functions if needed (for testing)
if ! declare -f dokku_log_info1 >/dev/null 2>&1; then
  dokku_log_info1() { echo "-----> $*"; }
fi

if ! declare -f dokku_log_info2 >/dev/null 2>&1; then
  dokku_log_info2() { echo "=====> $*"; }
fi

dns-triggers-enable-cmd() {
  declare desc="enable automatic DNS management for app lifecycle events"
  
  local TRIGGERS_ENABLED_FILE="$PLUGIN_DATA_ROOT/TRIGGERS_ENABLED"
  
  if [[ -f "$TRIGGERS_ENABLED_FILE" ]]; then
    dokku_log_info2 "DNS automatic management is already enabled ✅"
    return 0
  fi
  
  # Ensure plugin data directory exists
  [[ ! -d "$PLUGIN_DATA_ROOT" ]] && mkdir -p "$PLUGIN_DATA_ROOT"
  
  touch "$TRIGGERS_ENABLED_FILE"
  dokku_log_info1 "DNS automatic management enabled ✅"
  dokku_log_info2 "DNS records will now automatically sync when apps are created, deleted, or domains change"
}

dns-triggers-enable-cmd "$@"
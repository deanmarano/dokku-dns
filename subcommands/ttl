#!/usr/bin/env bash
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/config"
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# Load DNS plugin functions for TTL helpers
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/functions"

# Load dokku functions
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Load common fallback functions
source "$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")/common-functions"

dns-ttl-cmd() {
  declare desc="get or set the global DNS record TTL (time-to-live) in seconds"
  declare cmd="dns:ttl"
  [[ "$1" == "$cmd" ]] && shift 1

  local TTL_VALUE="$1"
  local TTL_CONFIG_FILE="$PLUGIN_DATA_ROOT/GLOBAL_TTL"

  # Ensure plugin data directory exists
  [[ ! -d "$PLUGIN_DATA_ROOT" ]] && mkdir -p "$PLUGIN_DATA_ROOT"

  if [[ -z "$TTL_VALUE" ]]; then
    # Get current TTL value
    if [[ -f "$TTL_CONFIG_FILE" ]]; then
      local current_ttl
      current_ttl=$(cat "$TTL_CONFIG_FILE")
      if [[ -n "$current_ttl" && "$current_ttl" =~ ^[0-9]+$ ]]; then
        echo "$current_ttl"
      else
        get_dns_ttl_config "default"  # Default fallback
      fi
    else
      get_dns_ttl_config "default"  # Default TTL
    fi
  else
    # Set TTL value
    if [[ ! "$TTL_VALUE" =~ ^[0-9]+$ ]]; then
      dokku_log_fail "TTL value must be a positive integer (seconds)"
    fi

    local min_ttl max_ttl
    min_ttl=$(get_dns_ttl_config "min")
    max_ttl=$(get_dns_ttl_config "max")

    if [[ "$TTL_VALUE" -lt "$min_ttl" ]]; then
      dokku_log_fail "TTL value must be at least $min_ttl seconds"
    fi

    if [[ "$TTL_VALUE" -gt "$max_ttl" ]]; then
      dokku_log_fail "TTL value must be no more than $max_ttl seconds"
    fi

    echo "$TTL_VALUE" > "$TTL_CONFIG_FILE"
    dokku_log_info1 "Global DNS TTL set to $TTL_VALUE seconds"
  fi
}

dns-ttl-cmd "$@"
#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# DNS Plugin - Post-Delete Trigger
# Automatically cleans up DNS management after an app has been successfully deleted

# Source plugin configuration
PLUGIN_BASE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$PLUGIN_BASE_PATH/config"

# Load functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Define missing functions if needed
if ! declare -f dokku_log_info1 >/dev/null 2>&1; then
  dokku_log_info1() { echo "-----> $*"; }
fi

if ! declare -f dokku_log_info2 >/dev/null 2>&1; then
  dokku_log_info2() { echo "=====> $*"; }
fi

if ! declare -f dokku_log_warn >/dev/null 2>&1; then
  dokku_log_warn() { echo " !     $*"; }
fi

# Load plugin functions
TRIGGER_BASE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$TRIGGER_BASE_PATH/functions"

# Main trigger logic
main() {
  local APP="$1"
  local IMAGE_TAG="$2" # Optional second argument

  # Check if triggers are enabled
  local TRIGGERS_ENABLED_FILE="$PLUGIN_DATA_ROOT/TRIGGERS_ENABLED"
  if [[ ! -f "$TRIGGERS_ENABLED_FILE" ]]; then
    # Triggers are disabled - exit silently
    return 0
  fi

  # Skip if no app provided
  [[ -z "$APP" ]] && return 0

  # Check if app is managed by DNS
  if ! is_app_dns_managed "$APP"; then
    # App not managed by DNS, nothing to clean up
    return 0
  fi

  dokku_log_info2 "DNS: Cleaning up DNS management for app '$APP'"

  # Get domains that were managed before removal
  local APP_DOMAINS_FILE="$PLUGIN_DATA_ROOT/$APP/DOMAINS"
  local managed_domains=()

  if [[ -f "$APP_DOMAINS_FILE" ]]; then
    while IFS= read -r domain; do
      [[ -n "$domain" ]] && managed_domains+=("$domain")
    done <"$APP_DOMAINS_FILE"
  fi

  if [[ ${#managed_domains[@]} -gt 0 ]]; then
    dokku_log_info1 "DNS: Removing DNS management for domains:"
    for domain in "${managed_domains[@]}"; do
      dokku_log_info1 "  â€¢ $domain"
    done
  fi

  # Remove app from DNS management
  local LINKS_FILE="$PLUGIN_DATA_ROOT/LINKS"
  if [[ -f "$LINKS_FILE" ]]; then
    # Create temp file without the app
    local TEMP_LINKS_FILE
    TEMP_LINKS_FILE=$(mktemp)
    grep -v "^$APP$" "$LINKS_FILE" >"$TEMP_LINKS_FILE" 2>/dev/null || true
    mv "$TEMP_LINKS_FILE" "$LINKS_FILE"
  fi

  # Remove app's domain tracking directory
  # Safety: Validate APP before deletion
  if [[ -n "$APP" && "$APP" != "/" && "$APP" != *".."* ]]; then
    if [[ -d "$PLUGIN_DATA_ROOT/$APP" ]]; then
      rm -rf "${PLUGIN_DATA_ROOT:?}/${APP:?}"
    fi
  fi

  if [[ ${#managed_domains[@]} -gt 0 ]]; then
    # Queue domains for potential deletion using the queue_domain_deletion function
    # Load multi-provider for zone lookup
    local MULTI_PROVIDER_PATH="$TRIGGER_BASE_PATH/providers/multi-provider.sh"
    if [[ -f "$MULTI_PROVIDER_PATH" ]]; then
      source "$MULTI_PROVIDER_PATH"
    fi

    for domain in "${managed_domains[@]}"; do
      # Get zone ID for this domain
      local zone_id=""
      if declare -f multi_get_zone_id >/dev/null 2>&1; then
        zone_id=$(multi_get_zone_id "$domain" 2>/dev/null || echo "")
      fi

      # Queue the domain for deletion (will only queue if it was managed by plugin)
      if declare -f queue_domain_deletion >/dev/null 2>&1; then
        queue_domain_deletion "$domain" "$zone_id"
      fi
    done

    dokku_log_info1 "DNS: App '$APP' removed from DNS management"
    dokku_log_info1 "DNS: Domains queued for cleanup: ${managed_domains[*]}"
    dokku_log_info1 "DNS: Run 'dokku $PLUGIN_COMMAND_PREFIX:sync:deletions' to clean up orphaned DNS records"
  else
    dokku_log_info1 "DNS: App '$APP' removed from DNS management (no domains were managed)"
  fi
}

# Run if called directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi

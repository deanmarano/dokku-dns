#!/usr/bin/env bash
# Test wrapper for dokku DNS commands

# Extract the DNS command  
# Handle both normal test environment and Docker test environment
# Use exported PLUGIN_ROOT if available, otherwise calculate from script location
if [[ -n "$PLUGIN_ROOT" && -d "$PLUGIN_ROOT/subcommands" ]]; then
    # Use the exported PLUGIN_ROOT from test environment
    true  # PLUGIN_ROOT is already set correctly
else
    # Calculate PLUGIN_ROOT from script location (fallback)
    BIN_DIR="$(dirname "${BASH_SOURCE[0]}")"
    if [[ -d "$BIN_DIR/../subcommands" ]]; then
        # Docker test environment - subcommands in same directory level
        PLUGIN_ROOT="$(cd "$BIN_DIR/.." && pwd)"
    else
        # Normal test environment - subcommands in parent's parent directory
        PLUGIN_ROOT="$(cd "$BIN_DIR/../.." && pwd)"
    fi
fi
if [[ "$1" == "dns:sync-all" ]]; then
    exec "$PLUGIN_ROOT/subcommands/sync-all" "${@:2}"
elif [[ "$1" == "dns:report" ]]; then
    exec "$PLUGIN_ROOT/subcommands/report" "${@:2}"
elif [[ "$1" == "dns:version" ]]; then
    exec "$PLUGIN_ROOT/subcommands/version" "${@:2}"
# New namespace commands
elif [[ "$1" == "dns:providers:configure" ]]; then
    exec "$PLUGIN_ROOT/subcommands/providers:configure" "${@:2}"
elif [[ "$1" == "dns:providers:verify" ]]; then
    exec "$PLUGIN_ROOT/subcommands/providers:verify" "${@:2}"
elif [[ "$1" == "dns:apps" ]]; then
    exec "$PLUGIN_ROOT/subcommands/apps" "${@:2}"
elif [[ "$1" == "dns:apps:enable" ]]; then
    exec "$PLUGIN_ROOT/subcommands/apps:enable" "${@:2}"
elif [[ "$1" == "dns:apps:disable" ]]; then
    exec "$PLUGIN_ROOT/subcommands/apps:disable" "${@:2}"
elif [[ "$1" == "dns:apps:sync" ]]; then
    exec "$PLUGIN_ROOT/subcommands/apps:sync" "${@:2}"
elif [[ "$1" == "dns:apps:report" ]]; then
    exec "$PLUGIN_ROOT/subcommands/apps:report" "${@:2}"
elif [[ "$1" == "dns:zones:enable" ]]; then
    exec "$PLUGIN_ROOT/subcommands/zones:enable" "${@:2}"
elif [[ "$1" == "dns:zones:disable" ]]; then
    exec "$PLUGIN_ROOT/subcommands/zones:disable" "${@:2}"
elif [[ "$1" == "dns:zones" ]]; then
    exec "$PLUGIN_ROOT/subcommands/zones" "${@:2}"
elif [[ "$1" == "dns:zones:add" ]]; then
    exec "$PLUGIN_ROOT/subcommands/zones:add" "${@:2}"
elif [[ "$1" == "dns:zones:remove" ]]; then
    exec "$PLUGIN_ROOT/subcommands/zones:remove" "${@:2}"
elif [[ "$1" == "dns:cron" ]]; then
    exec "$PLUGIN_ROOT/subcommands/cron" "${@:2}"
elif [[ "$1" == "dns:help" ]] || [[ "$1" == "dns" ]]; then
    exec "$PLUGIN_ROOT/commands" "$@"
elif [[ "$1" =~ ^dns:[^:]+:help$ ]]; then
    # Handle subcommand help like dns:configure:help
    SUBCOMMAND=${1#dns:}
    SUBCOMMAND=${SUBCOMMAND%:help}
    exec "$PLUGIN_ROOT/commands" "dns:help" "$SUBCOMMAND"
else
    # For non-DNS commands, provide basic mocks
    # Use apps tracking file from environment variable
    case "$1" in
        "apps:create")
            echo "Creating app: $2"
            if [[ -n "$DOKKU_APPS_FILE" ]]; then
                echo "$2" >> "$DOKKU_APPS_FILE"
            fi
            ;;
        "domains:add")
            echo "Adding domain $3 to app $2"
            # Store domain for this app
            if [[ -n "$DOKKU_APPS_FILE" ]]; then
                DOMAINS_DIR="$(dirname "$DOKKU_APPS_FILE")/domains"
                mkdir -p "$DOMAINS_DIR"
                echo "$3" >> "$DOMAINS_DIR/$2"
            fi
            ;;
        "domains:report")
            # Return domains for specific app if available
            APP_ARG="$2"
            if [[ -n "$DOKKU_APPS_FILE" ]]; then
                DOMAINS_DIR="$(dirname "$DOKKU_APPS_FILE")/domains"
                if [[ -f "$DOMAINS_DIR/$APP_ARG" ]]; then
                    tr '\n' ' ' < "$DOMAINS_DIR/$APP_ARG"
                    echo
                else
                    # No domains for this app
                    echo ""
                fi
            else
                echo "example.com api.example.com"
            fi
            ;;
        "apps:list")
            if [[ -f "$DOKKU_APPS_FILE" ]]; then
                cat "$DOKKU_APPS_FILE"
            else
                echo "testapp"
                echo "nextcloud"
            fi
            ;;
        *)
            echo "Mock dokku: $*"
            ;;
    esac
fi
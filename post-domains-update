#!/usr/bin/env bash
set -eo pipefail
[[ $DOKKU_TRACE ]] && set -x

# DNS Plugin - Post-Domains-Update Trigger
# Automatically adds new domains to DNS management when they're added to an app

# Source plugin configuration
PLUGIN_BASE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$PLUGIN_BASE_PATH/config"

# Load functions if available
if [[ -f "$PLUGIN_CORE_AVAILABLE_PATH/common/functions" ]]; then
  source "$PLUGIN_CORE_AVAILABLE_PATH/common/functions"
fi

# Define missing functions if needed
if ! declare -f dokku_log_info1 >/dev/null 2>&1; then
  dokku_log_info1() { echo "-----> $*"; }
fi

if ! declare -f dokku_log_info2 >/dev/null 2>&1; then
  dokku_log_info2() { echo "=====> $*"; }
fi

if ! declare -f dokku_log_warn >/dev/null 2>&1; then
  dokku_log_warn() { echo " !     $*"; }
fi

# Load plugin functions
TRIGGER_BASE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$TRIGGER_BASE_PATH/functions"

# Main trigger logic
main() {
  local APP="$1"
  local ACTION="$2"
  local DOMAIN="$3"

  # Check if triggers are enabled
  local TRIGGERS_ENABLED_FILE="$PLUGIN_DATA_ROOT/TRIGGERS_ENABLED"
  if [[ ! -f "$TRIGGERS_ENABLED_FILE" ]]; then
    # Triggers are disabled - exit silently
    return 0
  fi

  # Skip if no app provided
  [[ -z "$APP" ]] && return 0

  # Process both 'add' and 'remove' actions
  [[ "$ACTION" != "add" && "$ACTION" != "remove" ]] && return 0

  # Skip if no domain provided
  [[ -z "$DOMAIN" ]] && return 0

  # AWS is always the provider now - no configuration check needed

  if [[ "$ACTION" == "add" ]]; then
    handle_domain_add "$APP" "$DOMAIN"
  elif [[ "$ACTION" == "remove" ]]; then
    handle_domain_remove "$APP" "$DOMAIN"
  fi
}

# Handle domain addition
handle_domain_add() {
  local APP="$1"
  local DOMAIN="$2"

  dokku_log_info1 "DNS: Domain '$DOMAIN' added to app '$APP', checking DNS setup"

  # Check if app is already managed by DNS
  local app_was_managed=false
  if is_app_dns_managed "$APP"; then
    app_was_managed=true
  fi

  # Add the new domain to DNS management
  if dns_add_app_domains "$APP" "$DOMAIN"; then
    if [[ "$app_was_managed" == "false" ]]; then
      dokku_log_info1 "DNS: App '$APP' added to DNS management"
    fi
    dokku_log_info1 "DNS: Domain '$DOMAIN' added to DNS tracking"

    # Automatically sync the domain to make DNS records active
    dokku_log_info1 "DNS: Syncing DNS records for '$APP'..."
    if command -v dokku >/dev/null 2>&1; then
      if dokku "$PLUGIN_COMMAND_PREFIX:sync" "$APP" >/dev/null 2>&1; then
        dokku_log_info1 "DNS: Domain '$DOMAIN' DNS records synced successfully"
      else
        dokku_log_warn "DNS: Failed to sync DNS records automatically"
        dokku_log_info1 "DNS: Manual sync with: dokku $PLUGIN_COMMAND_PREFIX:sync $APP"
      fi
    else
      dokku_log_info1 "DNS: Manual sync with: dokku $PLUGIN_COMMAND_PREFIX:sync $APP"
    fi
  else
    dokku_log_warn "DNS: Failed to add domain '$DOMAIN' to DNS management"
  fi
}

# Handle domain removal
handle_domain_remove() {
  local APP="$1"
  local DOMAIN="$2"

  dokku_log_info1 "DNS: Domain '$DOMAIN' removed from app '$APP', updating DNS tracking..."

  # Skip if app is not managed by DNS
  if ! is_app_dns_managed "$APP"; then
    return 0
  fi

  local APP_DOMAINS_FILE="$PLUGIN_DATA_ROOT/$APP/DOMAINS"
  if [[ -f "$APP_DOMAINS_FILE" ]]; then
    # Remove the domain from the app's domain list
    local TEMP_DOMAINS_FILE="$APP_DOMAINS_FILE.tmp"
    grep -v "^$DOMAIN$" "$APP_DOMAINS_FILE" >"$TEMP_DOMAINS_FILE" 2>/dev/null || true
    mv "$TEMP_DOMAINS_FILE" "$APP_DOMAINS_FILE"

    dokku_log_info1 "DNS: Domain '$DOMAIN' removed from DNS tracking"

    # Queue domain for potential deletion using the queue_domain_deletion function
    # Load multi-provider for zone lookup
    local MULTI_PROVIDER_PATH="$TRIGGER_BASE_PATH/providers/multi-provider.sh"
    if [[ -f "$MULTI_PROVIDER_PATH" ]]; then
      source "$MULTI_PROVIDER_PATH"
    fi

    # Get zone ID for this domain
    local zone_id=""
    if declare -f multi_get_zone_id >/dev/null 2>&1; then
      zone_id=$(multi_get_zone_id "$DOMAIN" 2>/dev/null || echo "")
    fi

    # Queue the domain for deletion (will only queue if it was managed by plugin)
    if declare -f queue_domain_deletion >/dev/null 2>&1; then
      queue_domain_deletion "$DOMAIN" "$zone_id"
    fi

    dokku_log_info1 "DNS: Domain '$DOMAIN' queued for cleanup"
    dokku_log_info1 "DNS: Run 'dokku $PLUGIN_COMMAND_PREFIX:sync:deletions' to clean up orphaned DNS records"

    # Check if app still has any domains
    if [[ ! -s "$APP_DOMAINS_FILE" ]]; then
      # Safety: Validate APP before deletion
      if [[ -n "$APP" && "$APP" != "/" && "$APP" != *".."* ]]; then
        dokku_log_info1 "DNS: App '$APP' has no domains left, removing from DNS management"
        rm -rf "${PLUGIN_DATA_ROOT:?}/${APP:?}"
      fi

      # Remove app from LINKS file
      local LINKS_FILE="$PLUGIN_DATA_ROOT/LINKS"
      if [[ -f "$LINKS_FILE" ]]; then
        local TEMP_LINKS_FILE="$LINKS_FILE.tmp"
        grep -v "^$APP$" "$LINKS_FILE" >"$TEMP_LINKS_FILE" 2>/dev/null || true
        mv "$TEMP_LINKS_FILE" "$LINKS_FILE"
      fi
    fi
  fi
}

# Run if called directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
